# Agregaci√≥n y Window Functions

Este cap√≠tulo traduce `group_by() %>% summarise()` y funciones de ventana.

```{pyodide}
import pandas as pd
import numpy as np

# ============================================
# DATOS GPS ENRIQUECIDOS
# ============================================
np.random.seed(42)

gps = pd.DataFrame({
    'JugadorID': ['ATL_001', 'ATL_002', 'ATL_001', 'ATL_003', 'ATL_002', 
                 'ATL_001', 'ATL_003', 'ATL_002', 'ATL_001', 'ATL_004'] * 3,
    'Nombre': ['Garc√≠a', 'L√≥pez', 'Garc√≠a', 'Mart√≠nez', 'L√≥pez',
               'Garc√≠a', 'Mart√≠nez', 'L√≥pez', 'Garc√≠a', 'S√°nchez'] * 3,
    'Posicion': ['Delantero', 'Mediocentro', 'Delantero', 'Defensa', 'Mediocentro',
                 'Delantero', 'Defensa', 'Mediocentro', 'Delantero', 'Portero'] * 3,
    'TipoSesion': ['Entrenamiento', 'Partido', 'Partido', 'Entrenamiento', 'Entrenamiento',
                  'Entrenamiento', 'Partido', 'Partido', 'Partido', 'Entrenamiento'] * 3,
    'Distancia_Total_m': [4500, 10200, 9800, 3200, 4100, 5600, 11500, 10800, 11000, 3000] * 3,
    'HSR_m': [150, 800, 750, 50, 120, 300, 950, 880, 900, 20] * 3,
    'Sprint_m': [45, 280, 250, 15, 35, 90, 320, 300, 310, 5] * 3,
    'RPE': [3, 8, 9, 2, 4, 5, 10, 8, 9, 2] * 3,
    'Duracion_min': [60, 95, 95, 45, 60, 75, 98, 96, 95, 40] * 3,
    'HR_Media': [135, 165, 168, 125, 140, 145, 172, 167, 170, 120] * 3,
    'Fecha': pd.date_range(start='2024-01-01', periods=30).strftime('%Y-%m-%d').tolist()
})

print("‚úÖ Datos GPS cargados:", gps.shape)
print(f"   Columnas: {', '.join(gps.columns[:6])}...")
```

***

## 1. GroupBy + Agregaci√≥n

### Ejemplo 1.1: Agregaci√≥n simple

**En R:** `gps %>% group_by(JugadorID) %>% summarise(Media = mean(Distancia_Total_m))`

**En Pandas:**
```{pyodide}
gps.groupby('JugadorID')['Distancia_Total_m'].mean()
```

### Ejemplo 1.2: M√∫ltiples agregaciones

**En R:** `summarise(Media = mean(x), Total = sum(y), Max = max(z))`

```{pyodide}
(
    gps
    .groupby('JugadorID')
    .agg(
        Media_Dist = ('Distancia_Total_m', 'mean'),
        Total_HSR = ('HSR_m', 'sum'),
        RPE_Max = ('RPE', 'max'),
        N_Sesiones = ('RPE', 'count')
    )
)
```

---

### üß† Pr√°ctica 1.1

Agrupa por TipoSesion y calcula: media de Distancia, suma de HSR, conteo.

```{pyodide}
# Pista: .groupby('col').agg(nombre = ('col', 'func'))

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```python
gps.groupby('TipoSesion').agg(
    Media_Dist = ('Distancia_Total_m', 'mean'),
    Total_HSR = ('HSR_m', 'sum'),
    N = ('RPE', 'count')
)
```
:::

***

## 2. Window Functions

### Ejemplo 2.1: Rolling (Media M√≥vil)

**En R:** `mutate(Rolling = slide_dbl(x, mean, .before = 2))`

```{pyodide}
gps_copy = gps.copy()
gps_copy['Dist_Rolling_3'] = gps_copy['Distancia_Total_m'].rolling(window=3).mean()
gps_copy[['JugadorID', 'Distancia_Total_m', 'Dist_Rolling_3']].head(10)
```

### Ejemplo 2.2: shift (lag/lead)

**En R:** `mutate(Anterior = lag(x))`

```{pyodide}
gps_copy = gps.copy()
gps_copy['Dist_Anterior'] = gps_copy['Distancia_Total_m'].shift(1)
gps_copy[['Distancia_Total_m', 'Dist_Anterior']].head()
```

### Ejemplo 2.3: transform (agregar sin colapsar)

**En R:** `group_by() %>% mutate(Media_Grupo = mean(x))`

```{pyodide}
gps_copy = gps.copy()
gps_copy['Media_Jugador'] = gps_copy.groupby('JugadorID')['Distancia_Total_m'].transform('mean')
gps_copy[['JugadorID', 'Distancia_Total_m', 'Media_Jugador']].head()
```

---

### üß† Pr√°ctica 2.1

Crea una columna 'Ranking' que ordene las sesiones por Distancia (1 = mayor).

```{pyodide}
# Pista: .rank(ascending=False)

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```python
gps_copy = gps.copy()
gps_copy['Ranking'] = gps_copy['Distancia_Total_m'].rank(ascending=False).astype(int)
gps_copy.nsmallest(5, 'Ranking')[['JugadorID', 'Distancia_Total_m', 'Ranking']]
```
:::

***

## üèÜ Mini-Proyecto: Monitorizaci√≥n de Carga de Entrenamiento

### Pregunta 1: Carga Acumulada por Jugador
¬øQu√© jugador ha acumulado m√°s metros en sprint? Muestra el top 3.

```{pyodide}
# Pista: groupby + sum + nlargest

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```python
gps.groupby('Nombre')['Sprint_m'].sum().nlargest(3)
```
:::

### Pregunta 2: Perfil de Carga por Posici√≥n
¬øCu√°l es la distancia media en partidos para cada posici√≥n? ¬øQui√©n corre m√°s?

```{pyodide}
# Pista: Filtra primero por TipoSesion, luego agrupa

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```python
(
    gps
    .query("TipoSesion == 'Partido'")
    .groupby('Posicion')['Distancia_Total_m']
    .mean()
    .sort_values(ascending=False)
)
```
:::

### Pregunta 3: Media M√≥vil de Carga Semanal
Calcula la media m√≥vil de 3 d√≠as del RPE para el jugador Garc√≠a. Esto ayuda a detectar fatiga acumulada.

```{pyodide}
# Pista: Filtra por nombre, ordena por fecha, aplica rolling

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```python
garcia = gps.query("Nombre == 'Garc√≠a'").sort_values('Fecha').copy()
garcia['RPE_Rolling_3'] = garcia['RPE'].rolling(window=3).mean()
garcia[['Fecha', 'TipoSesion', 'RPE', 'RPE_Rolling_3']]
```
:::

### Pregunta 4: Comparar Rendimiento Individual vs Grupo
Para cada sesi√≥n, calcula cu√°nto difiere la distancia del jugador respecto a la media del grupo ese d√≠a.

```{pyodide}
# Pista: Usa transform para agregar sin colapsar

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```python
gps_copy = gps.copy()
gps_copy['Media_Dia'] = gps_copy.groupby('Fecha')['Distancia_Total_m'].transform('mean')
gps_copy['Diff_vs_Grupo'] = gps_copy['Distancia_Total_m'] - gps_copy['Media_Dia']
gps_copy[['Nombre', 'Fecha', 'Distancia_Total_m', 'Media_Dia', 'Diff_vs_Grupo']].head(10)
```
:::

---

## Resumen

| Operaci√≥n | R (Tidyverse) | Python (Pandas) |
|-----------|---------------|-----------------|
| Agrupar + resumir | `group_by() %>% summarise()` | `.groupby().agg()` |
| Media m√≥vil | `slide_dbl(..., mean)` | `.rolling(n).mean()` |
| Lag | `lag(x)` | `.shift(1)` |
| Agregar sin colapsar | `mutate()` en group_by | `.transform()` |
