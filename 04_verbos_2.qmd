# Verbos BÃ¡sicos II: TransformaciÃ³n de Datos

Este capÃ­tulo traduce `mutate()` de dplyr.

```{pyodide}
import pandas as pd
import numpy as np

# ============================================
# DATOS ENRIQUECIDOS PARA SPORT SCIENTISTS
# ============================================
atletas = pd.DataFrame({
    'JugadorID': [f'ATL_{i:03d}' for i in range(1, 16)],
    'Nombre': ['GarcÃ­a', 'LÃ³pez', 'MartÃ­nez', 'SÃ¡nchez', 'FernÃ¡ndez', 
               'GonzÃ¡lez', 'RodrÃ­guez', 'PÃ©rez', 'GÃ³mez', 'Ruiz',
               'DÃ­az', 'Moreno', 'Ãlvarez', 'JimÃ©nez', 'Romero'],
    'Posicion': ['Delantero', 'Mediocentro', 'Defensa', 'Portero', 'Delantero',
                'Mediocentro', 'Defensa', 'Delantero', 'Mediocentro', 'Defensa',
                'Portero', 'Delantero', 'Mediocentro', 'Defensa', 'Extremo'],
    'Edad': [25, 28, 23, 31, 22, 27, 29, 24, 26, 30, 33, 21, 25, 28, 23],
    'Altura_cm': [178, 175, 182, 188, 176, 180, 185, 173, 177, 184, 190, 172, 179, 183, 175],
    'Peso_kg': [75, 72, 80, 85, 70, 76, 82, 68, 74, 81, 87, 67, 73, 79, 71],
    'VO2max': [58.5, 62.1, 55.0, 48.2, 60.5, 59.0, 54.5, 61.0, 57.5, 53.0, 46.0, 63.0, 58.0, 55.5, 59.5],
    'FC_Max': [195, 188, 192, 185, 198, 190, 186, 196, 191, 184, 180, 200, 193, 187, 197],
    'FC_Reposo': [52, 48, 55, 58, 50, 51, 54, 49, 53, 56, 60, 47, 52, 55, 50],
    'Potencia_W': [850, 780, 920, 950, 720, 810, 890, 700, 790, 880, 920, 680, 800, 860, 740],
    'SaltoCMJ_cm': [42, 38, 45, 48, 40, 41, 44, 39, 40, 43, 46, 37, 41, 44, 39]
})

print("âœ… Datos cargados:", atletas.shape)
```

***

## 1. Crear Columnas con .assign()

### Ejemplo 1.1: Columna calculada

**En R:** `atletas %>% mutate(IMC = Peso_kg / (Altura_cm/100)^2)`

**En Pandas:**
```{pyodide}
(
    atletas
    .assign(IMC = lambda x: x['Peso_kg'] / (x['Altura_cm']/100)**2)
    [['Nombre', 'Peso_kg', 'Altura_cm', 'IMC']]
    .head()
)
```

**Â¿Por quÃ© `lambda x`?** `x` representa el DataFrame actual. Similar a `.` en magrittr.

---

### ðŸ§  PrÃ¡ctica 1.1

Crea una columna `Altura_m` que convierta la altura de cm a metros.

```{pyodide}
# Pista: .assign(Col = lambda x: x['col'] / 100)

# Escribe tu cÃ³digo aquÃ­:


```

::: {.callout-tip collapse="true"}
## Ver soluciÃ³n
```python
atletas.assign(Altura_m = lambda x: x['Altura_cm'] / 100)[['Nombre', 'Altura_m']].head()
```
:::

***

## 2. LÃ³gica Condicional

### Ejemplo 2.1: np.where (if_else)

**En R:** `mutate(Veterano = if_else(Edad > 28, "SÃ­", "No"))`

**En Pandas:**
```{pyodide}
(
    atletas
    .assign(Veterano = lambda x: np.where(x['Edad'] > 28, 'SÃ­', 'No'))
    [['Nombre', 'Edad', 'Veterano']]
    .head()
)
```

### Ejemplo 2.2: np.select (case_when)

**En R:** `case_when(Edad < 23 ~ "Joven", Edad <= 28 ~ "Prime", TRUE ~ "Veterano")`

```{pyodide}
conds = [atletas['Edad'] < 23, atletas['Edad'] <= 28, atletas['Edad'] > 28]
vals = ['Joven', 'Prime', 'Veterano']

atletas.assign(Categoria = np.select(conds, vals))[['Nombre', 'Edad', 'Categoria']].head()
```

---

### ðŸ§  PrÃ¡ctica 2.1

Crea 'Nivel_VO2': "Ã‰lite" si VO2max >= 60, "Normal" si >= 50, "Bajo" si < 50.

```{pyodide}
# Pista: Crea listas de condiciones y valores
# Usa np.select(condiciones, valores)

# Escribe tu cÃ³digo aquÃ­:


```

::: {.callout-tip collapse="true"}
## Ver soluciÃ³n
```python
conds = [atletas['VO2max'] >= 60, atletas['VO2max'] >= 50, atletas['VO2max'] < 50]
vals = ['Ã‰lite', 'Normal', 'Bajo']
atletas.assign(Nivel_VO2 = np.select(conds, vals))[['Nombre', 'VO2max', 'Nivel_VO2']].head()
```
:::

***

## 3. Operaciones de Texto

### Ejemplo 3.1: MÃ©todos .str

**En R:** `mutate(Nombre_Upper = str_to_upper(Nombre))`

```{pyodide}
(
    atletas
    .assign(
        Nombre_Upper = lambda x: x['Nombre'].str.upper(),
        Inicial = lambda x: x['Nombre'].str[0]
    )
    [['Nombre', 'Nombre_Upper', 'Inicial']]
    .head()
)
```

***

## ðŸ† Mini-Proyecto: MÃ©tricas de Rendimiento Derivadas

### Pregunta 1: IMC y ComposiciÃ³n Corporal
Calcula el IMC de cada atleta. Â¿QuiÃ©n tiene el IMC mÃ¡s alto y mÃ¡s bajo? Â¿Son los porteros?

```{pyodide}
# Pista: IMC = Peso / (Altura_m)^2

# Escribe tu cÃ³digo aquÃ­:


```

::: {.callout-tip collapse="true"}
## Ver soluciÃ³n
```python
(
    atletas
    .assign(IMC = lambda x: x['Peso_kg'] / (x['Altura_cm']/100)**2)
    .sort_values('IMC', ascending=False)
    [['Nombre', 'Posicion', 'IMC']]
    .head(3)
)
```
:::

### Pregunta 2: Potencia Relativa (W/kg)
Calcula la potencia relativa dividiendo Potencia_W entre Peso_kg. Â¿QuiÃ©n tiene mejor ratio potencia/peso?

```{pyodide}
# Pista: .assign(Potencia_Rel = lambda x: x['Potencia_W'] / x['Peso_kg'])

# Escribe tu cÃ³digo aquÃ­:


```

::: {.callout-tip collapse="true"}
## Ver soluciÃ³n
```python
(
    atletas
    .assign(Potencia_Rel = lambda x: round(x['Potencia_W'] / x['Peso_kg'], 2))
    .nlargest(5, 'Potencia_Rel')
    [['Nombre', 'Posicion', 'Potencia_W', 'Peso_kg', 'Potencia_Rel']]
)
```
:::

### Pregunta 3: Reserva de Frecuencia CardÃ­aca
Calcula la Reserva FC (FC_Max - FC_Reposo). Clasifica como "Alta" (>140), "Normal" (120-140), "Baja" (<120).

```{pyodide}
# Pista: Usa np.select para clasificar

# Escribe tu cÃ³digo aquÃ­:


```

::: {.callout-tip collapse="true"}
## Ver soluciÃ³n
```python
df = atletas.assign(Reserva_FC = lambda x: x['FC_Max'] - x['FC_Reposo'])
conds = [df['Reserva_FC'] > 140, df['Reserva_FC'] >= 120, df['Reserva_FC'] < 120]
vals = ['Alta', 'Normal', 'Baja']
df.assign(Nivel_Reserva = np.select(conds, vals))[['Nombre', 'Reserva_FC', 'Nivel_Reserva']].head()
```
:::

### Pregunta 4: Perfil de Rendimiento AerÃ³bico
Clasifica atletas por VO2max: "Ã‰lite" (>=60), "Bueno" (55-59), "Promedio" (50-54), "Bajo" (<50). Â¿CuÃ¡ntos hay en cada categorÃ­a?

```{pyodide}
# Pista: Crea condiciones y valores, luego usa value_counts()

# Escribe tu cÃ³digo aquÃ­:


```

::: {.callout-tip collapse="true"}
## Ver soluciÃ³n
```python
conds = [
    atletas['VO2max'] >= 60, 
    atletas['VO2max'] >= 55, 
    atletas['VO2max'] >= 50, 
    atletas['VO2max'] < 50
]
vals = ['Ã‰lite', 'Bueno', 'Promedio', 'Bajo']
atletas.assign(Nivel_Aerobico = np.select(conds, vals))['Nivel_Aerobico'].value_counts()
```
:::

---

## Resumen

| OperaciÃ³n | R (Tidyverse) | Python (Pandas) |
|-----------|---------------|-----------------|
| Crear columna | `mutate(col = expr)` | `.assign(col = lambda x: expr)` |
| If-else | `if_else(cond, T, F)` | `np.where(cond, T, F)` |
| Case-when | `case_when(...)` | `np.select([conds], [vals])` |
| MayÃºsculas | `str_to_upper()` | `.str.upper()` |
